#' Generate posterior predictions for fixed effects brmsfit model via [marginaleffects::predictions()]
#'
#' @param model A brmsfit object
#' @param data Data with the desired combination of levels of the predictors for which to generate posterior predictions, as generated by [generate_newdata()]
#' @inheritParams marginaleffects::datagrid
posterior_predictions <- function(model, data, ...) {
    # generate data for predictions
    newdata <- generate_newdata(model, data, 
                                age_std = scale(seq(0, 50),
                                                mean(data$age),
                                                sd(data$age)),
                                dominance = c("L1", "L2"),
                                lp = c("Monolingual", "Bilingual"))
    
    # use marginaleffects to get posterior means
    predictions <- predictions(model,
                               newdata = newdata,
                               re_formula = NA,
                               vcov = FALSE,
                               ndraws = 50) |>
        posteriordraws() |> # so that each draw gets a row
        as_tibble() |>
        clean_names() |> 
        filter(group != "No") |> 
        pivot_wider(id_cols = any_of(c("drawid", colnames(newdata))),
                    names_from = group,
                    values_from = draw) |>
        mutate(`Understands` = `Understands and Says` + `Understands`) |>
        pivot_longer(c(`Understands`, `Understands and Says`),
                     names_to = "group",
                     values_to = "draw") |>
        select(any_of(colnames(newdata)),
               .category = group,
               .draw = drawid,
               .value = draw)
    
    # save predictions as Parquet file
    save_files(predictions, folder = "results/predictions")
    saveRDS(predictions, "bvq-app/data/predictions.rds")
    
    return(predictions)
}

#' Generate posterior predictions for fixed effects brmsfit model via [marginaleffects::predictions()]
#'
#' @param model A brmsfit object
#' @param data Data with the desired combination of levels of the predictors for which to generate posterior predictions, as generated by \code{generate_newdata}
#' @param group Group level for which posterior predictions are generated. Takes `"te"` or `"id"` as values.
#' @param ... Additional arguments passed to [marginaleffects::predictions()]
posterior_predictions_re <- function(model, data, group, ...) {
    if (!(group %in% c("id", "te"))) {
        cli_abort("group must be 'id' or 'te'")
    }
    # generate data for predictions
    newdata <- generate_newdata(model, data, group, ...)
    
    # use marginaleffects to get posterior means
    preds <- predictions(model,
                         newdata = newdata,
                         re_formula = as.formula(paste0("~ 1 | ", group)),
                         vcov = FALSE,
                         ndraws = 10) |>
        posteriordraws() |> # so that each draw gets a row
        as_tibble() |>
        clean_names() |>
        filter(group != "No") |>
        pivot_wider(id_cols = c(drawid, age_std, lv_std, exposure_std, te, id),
                    names_from = group,
                    values_from = draw) |>
        mutate(`Understands` = `Understands and Says` + `Understands`) |>
        pivot_longer(c(`Understands`, `Understands and Says`),
                     names_to = "group",
                     values_to = "draw") |>
        mutate(age = age_std * sd(data$age) + mean(data$age))
    
    if (group == "te") {
        predictions_te <- preds
        # export results
        save_files(predictions_te, folder = "results/predictions")
        saveRDS(predictions, "bvq-app/data/predictions_te.rds")
        predictions_re <- predictions_te
    }
    
    if (group == "id") {
        predictions_id <- preds
        # export results
        save_files(predictions_id, folder = "results/predictions")
        saveRDS(predictions, "bvq-app/data/predictions_id.rds")
        predictions_re <- predictions_id
    }
    
    return(predictions_re)
}